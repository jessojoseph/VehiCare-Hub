{% extends 'basew.html' %}

{% block title %}Update Work Status{% endblock %}

{% block content %}
    <h1 class="text-center mb-4">Update Work Status</h1>

    <p><strong>Title:</strong> {{ task.title }}</p>
    <p><strong>Description:</strong> {{ task.description }}</p>
    <p><strong>Vehicle Registration Number:</strong> {{ task.appointment.registration_number }}</p>
    <p><strong>Service Type:</strong> {{ task.appointment.service_type.service_name }}</p>

    <form method="post">
        {% csrf_token %}
        <div class="form-group">
            <label for="new_status">New Status:</label>
            <select class="form-control" id="new_status" name="new_status">
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
        </div>

        <!-- Additional fields for capturing work details -->
        <div class="form-group">
            <label for="work_done">Work Done:</label>
            <textarea class="form-control" id="work_done" name="work_done" rows="4">{{ task.work_done }}</textarea>
        </div>

        <div class="form-group">
            <label for="materials_used">Materials Used:</label>
            <textarea class="form-control" id="materials_used" name="materials_used" rows="4">{{ task.materials_used }}</textarea>
        </div>

        <div class="form-group">
            <label for="additional_notes">Additional Notes:</label>
            <textarea class="form-control" id="additional_notes" name="additional_notes" rows="4">{{ task.additional_notes }}</textarea>
        </div>

    <!-- New audio recording section -->
    <div class="form-group">
        <label for="record_audio">Record Audio:</label>
        <button type="button" id="start_stop_recording" class="btn btn-primary">Start Recording</button>
        <input type="hidden" id="audio_data" name="audio_data" />
        <audio id="audio-player" controls style="display: none;"></audio>
        <div id="recording-status"></div>
        <textarea class="form-control" id="recognized_text" name="recognized_text" rows="4" readonly></textarea>
    </div>
    
      <button type="submit" class="btn btn-primary">Update Status</button>
      
 <!-- ... Existing JavaScript ... -->

<script>
    // JavaScript to handle audio recording and playback
    const startStopRecordingButton = document.getElementById('start_stop_recording');
    const audioDataInput = document.getElementById('audio_data');
    const audioPlayer = document.getElementById('audio-player');
    const recordingStatusDiv = document.getElementById('recording-status');
    const recognizedTextArea = document.getElementById('recognized_text');
    let mediaRecorder;
    let audioChunks = [];
    let recognition; // Declare the recognition object outside the loop
    let isRecording = false;

    startStopRecordingButton.addEventListener('click', () => {
        if (!isRecording) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        audioDataInput.value = audioBlob;
                        recordingStatusDiv.textContent = 'Recording stopped.';
                        audioPlayer.src = URL.createObjectURL(audioBlob); // Set the audio player source
                        audioPlayer.style.display = 'block'; // Show the audio player
                        isRecording = false;
                    };

                    mediaRecorder.start();
                    startStopRecordingButton.textContent = 'Stop Recording';
                    recordingStatusDiv.textContent = 'Recording...';
                    isRecording = true;

                    // Speech recognition logic
                    recognition = new webkitSpeechRecognition();
                    recognition.lang = 'en-US';

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        recognizedTextArea.value = transcript;
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                    };

                    recognition.onend = () => {
                        // Restart recognition when it ends
                        if (isRecording) {
                            recognition.start();
                        }
                    };

                    recognizedTextArea.value = 'Recognizing...';
                    recognition.start();
                })
                .catch(function (error) {
                    console.error('Error accessing microphone:', error);
                });
        } else {
            mediaRecorder.stop();
            recognition.stop(); // Stop the recognition loop
            startStopRecordingButton.textContent = 'Start Recording';
            recordingStatusDiv.textContent = 'Recording stopped.';
            isRecording = false;
        }
    });

    // ... (rest of your speech recognition code) ...

</script>

<!-- ... Existing JavaScript ... -->

{% endblock %}
